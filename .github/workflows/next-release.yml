name: Multi-Platform Build and Release

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode (no push to registry, save artifacts)'
        required: false
        default: false
        type: boolean
      platforms:
        description: 'Platforms to build (comma separated: linux,windows,macos)'
        required: false
        default: 'linux,windows,macos'
        type: string
      build_docker:
        description: 'Build and push Docker image'
        required: false
        default: true
        type: boolean
      use_china_mirror:
        description: 'Use China mirror for faster downloads'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  BINARY_NAME: ${{ github.event.repository.name }}

jobs:
  setup-platforms:
    name: Setup Platform Flags
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.parse-platforms.outputs.build_linux }}
      build_windows: ${{ steps.parse-platforms.outputs.build_windows }}
      build_macos: ${{ steps.parse-platforms.outputs.build_macos }}
    
    steps:
      - name: Parse platforms input
        id: parse-platforms
        run: |
          PLATFORMS=$(echo "${{ inputs.platforms }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          
          if [[ "$PLATFORMS" == *"linux"* ]]; then
            echo "build_linux=true" >> $GITHUB_OUTPUT
          else
            echo "build_linux=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$PLATFORMS" == *"windows"* ]]; then
            echo "build_windows=true" >> $GITHUB_OUTPUT
          else
            echo "build_windows=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$PLATFORMS" == *"macos"* ]]; then
            echo "build_macos=true" >> $GITHUB_OUTPUT
          else
            echo "build_macos=false" >> $GITHUB_OUTPUT
          fi

  build-linux-binary:
    name: Build Linux Static Binary
    runs-on: ubuntu-latest
    needs: setup-platforms
    if: ${{ needs.setup-platforms.outputs.build_linux == 'true' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install musl toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: x86_64-unknown-linux-musl
      
      - name: Build static binary
        run: |
          echo "ğŸ—ï¸ Building Linux static binary (musl)..."
          cargo build --release --target x86_64-unknown-linux-musl
          
          echo "ğŸ“Š Binary info:"
          file target/x86_64-unknown-linux-musl/release/$BINARY_NAME
      
      - name: Test binary
        run: |
          echo "ğŸ§ª Testing Linux binary..."
          ./target/x86_64-unknown-linux-musl/release/$BINARY_NAME --version || \
          ./target/x86_64-unknown-linux-musl/release/$BINARY_NAME --help || \
          echo "âœ… Binary execution successful"
      
      - name: Prepare artifact
        run: |
          mkdir -p release-binaries
          cp target/x86_64-unknown-linux-musl/release/$BINARY_NAME \
             release-binaries/$BINARY_NAME-linux-amd64
          chmod +x release-binaries/$BINARY_NAME-linux-amd64
          
          FILE_SIZE=$(du -h release-binaries/$BINARY_NAME-linux-amd64 | cut -f1)
          echo "binary_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“„ Binary: $BINARY_NAME-linux-amd64 ($FILE_SIZE)"
      
      - name: Upload Linux binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-static-binary
          path: release-binaries/$BINARY_NAME-linux-amd64
          retention-days: 1

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: setup-platforms
    if: ${{ inputs.build_docker }}
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up lowercase repository name
        id: repo
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        if: ${{ !inputs.debug_mode }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract Docker image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.repo.outputs.repo_lower }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix=git-
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: ${{ !inputs.debug_mode }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            USE_CHINA_MIRROR=${{ inputs.use_china_mirror }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: ${{ inputs.debug_mode && 'type=docker,dest=/tmp/image.tar' || '' }}
      
      - name: Test Docker image (debug mode)
        if: ${{ inputs.debug_mode }}
        run: |
          echo "ğŸ”§ Debug mode: Testing Docker image..."
          
          # åŠ è½½æœ¬åœ°ä¿å­˜çš„é•œåƒ
          docker load -i /tmp/image.tar
          
          # è·å–é•œåƒä¿¡æ¯
          IMAGE_ID=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -1)
          echo "Loaded image: $IMAGE_ID"
          
          # æµ‹è¯•å®¹å™¨è¿è¡Œ
          docker run --rm "$IMAGE_ID" --version || \
          docker run --rm "$IMAGE_ID" --help || \
          echo "âœ… Docker container runs successfully"
      
      - name: Save debug artifacts
        if: ${{ inputs.debug_mode }}
        run: |
          mkdir -p /tmp/debug-artifacts
          cp /tmp/image.tar /tmp/debug-artifacts/docker-image-debug.tar
          echo "âœ… Debug artifacts saved"
      
      - name: Upload debug artifacts
        if: ${{ inputs.debug_mode }}
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-debug
          path: /tmp/debug-artifacts/
          retention-days: 1

  build-windows:
    name: Build Windows Binaries
    runs-on: windows-latest
    needs: setup-platforms
    if: ${{ needs.setup-platforms.outputs.build_windows == 'true' }}
    strategy:
      matrix:
        target: [x86_64-pc-windows-msvc]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Build
        run: |
          echo "ğŸ—ï¸ Building for target: ${{ matrix.target }}"
          cargo build --release --target ${{ matrix.target }}
      
      - name: Test binary
        run: |
          $binaryPath = "target\${{ matrix.target }}\release\$env:BINARY_NAME.exe"
          & $binaryPath --version || & $binaryPath --help || echo "âœ… Binary test completed"
      
      - name: Prepare artifact
        run: |
          $binaryPath = "target\${{ matrix.target }}\release\$env:BINARY_NAME.exe"
          $artifactDir = "release-artifacts"
          
          New-Item -ItemType Directory -Force -Path $artifactDir
          $outputName = "$env:BINARY_NAME-windows-amd64.exe"
          Copy-Item $binaryPath "$artifactDir\$outputName"
          
          $fileInfo = Get-Item "$artifactDir\$outputName"
          $fileSize = [math]::Round($fileInfo.Length / 1MB, 2)
          echo "âœ… Prepared: $outputName (${fileSize} MB)"
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: release-artifacts/
          retention-days: 1

  build-macos:
    name: Build macOS Binaries
    runs-on: macos-latest
    needs: setup-platforms
    if: ${{ needs.setup-platforms.outputs.build_macos == 'true' }}
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Build
        run: |
          echo "ğŸ—ï¸ Building for target: ${{ matrix.target }}"
          cargo build --release --target ${{ matrix.target }}
      
      - name: Test binary
        run: |
          binary_path="target/${{ matrix.target }}/release/$BINARY_NAME"
          ./$binary_path --version || ./$binary_path --help || echo "âœ… Binary test completed"
      
      - name: Prepare artifact
        run: |
          binary_path="target/${{ matrix.target }}/release/$BINARY_NAME"
          artifact_dir="release-artifacts"
          
          mkdir -p $artifact_dir
          
          if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
            output_name="$BINARY_NAME-macos-arm64"
          else
            output_name="$BINARY_NAME-macos-amd64"
          fi
          
          cp $binary_path "$artifact_dir/$output_name"
          chmod +x "$artifact_dir/$output_name"
          
          file_size=$(du -h "$artifact_dir/$output_name" | cut -f1)
          echo "âœ… Prepared: $output_name (${file_size})"
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: release-artifacts/
          retention-days: 1

  create-release:
    name: Create Unified Release
    runs-on: ubuntu-latest
    needs: 
      - setup-platforms
      - build-linux-binary
      - build-windows
      - build-macos
    permissions:
      contents: write
    if: >
      !inputs.debug_mode &&
      startsWith(github.ref, 'refs/tags/v') &&
      (needs.setup-platforms.outputs.build_linux == 'true' ||
       needs.setup-platforms.outputs.build_windows == 'true' ||
       needs.setup-platforms.outputs.build_macos == 'true')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Linux binary
        if: ${{ needs.setup-platforms.outputs.build_linux == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: linux-static-binary
          path: release-assets
      
      - name: Download Windows binaries
        if: ${{ needs.setup-platforms.outputs.build_windows == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: release-assets
      
      - name: Download macOS binaries
        if: ${{ needs.setup-platforms.outputs.build_macos == 'true' }}
        uses: actions/download-artifact@v4
        with:
          pattern: macos-*
          path: release-assets
      
      - name: Prepare release files
        run: |
          mkdir -p final-release
          
          # ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶åˆ° final-releaseï¼Œç¡®ä¿æ­£ç¡®çš„å‘½å
          find release-assets -type f ! -name "*.json" | while read file; do
            filename=$(basename "$file")
            
            # æ ‡å‡†åŒ–æ–‡ä»¶å
            if [[ "$filename" == *"linux-amd64" ]]; then
              cp "$file" "final-release/$filename"
            elif [[ "$filename" == *".exe" ]]; then
              cp "$file" "final-release/$filename"
            elif [[ "$filename" == *"macos-"* ]]; then
              cp "$file" "final-release/$filename"
            else
              # é‡å‘½åä»¥ç¡®ä¿ä¸€è‡´æ€§
              new_name=$(echo "$filename" | sed -E 's/.*(x86_64|aarch64).*\.exe$/$BINARY_NAME-windows-amd64.exe/')
              cp "$file" "final-release/$filename"
            fi
          done
          
          echo "ğŸ“¦ Release files:"
          ls -la final-release/
      
      - name: Create checksums
        run: |
          cd final-release
          for file in *; do
            sha256sum "$file" > "$file.sha256"
            sha512sum "$file" > "$file.sha512"
            echo "âœ… $file"
          done
      
      - uses: softprops/action-gh-release@v1
        with:
          files: final-release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  debug-mode-report:
    name: Debug Mode Report
    runs-on: ubuntu-latest
    needs: 
      - setup-platforms
      - build-linux-binary
      - build-docker
      - build-windows
      - build-macos
    if: ${{ inputs.debug_mode }}
    
    steps:
      - name: Debug report
        run: |
          echo "ğŸ”§ Debug Mode Completed Successfully!"
          echo "===================================="
          echo "ğŸ“‹ Selected platforms: ${{ inputs.platforms }}"
          echo ""
          echo "ğŸ—ï¸ Build status:"
          echo "  ğŸ§ Linux static binary: ${{ needs.setup-platforms.outputs.build_linux && 'âœ… Built' || 'â¸ï¸  Skipped' }}"
          echo "  ğŸ³ Docker image: ${{ inputs.build_docker && 'âœ… Built (local)' || 'â¸ï¸  Skipped' }}"
          echo "  ğŸªŸ Windows binaries: ${{ needs.setup-platforms.outputs.build_windows && 'âœ… Built' || 'â¸ï¸  Skipped' }}"
          echo "  ğŸ macOS binaries: ${{ needs.setup-platforms.outputs.build_macos && 'âœ… Built' || 'â¸ï¸  Skipped' }}"
          echo ""
          echo "ğŸ’¾ All artifacts saved locally"
          echo "ğŸš« No images pushed to registry"
          echo "ğŸš« No release created"
          echo ""
          echo "ğŸ”„ To publish, re-run with:"
          echo "  - debug_mode: false"
          echo "  - platforms: '${{ inputs.platforms }}'"
          echo "  - build_docker: ${{ inputs.build_docker }}"