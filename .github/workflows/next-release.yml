name: Next Build and Release

on:
  push:
    tags:
      - 'v*'           # v1.0.0, v2.3.4-beta.1 ç­‰
      - '[0-9][0-9]*'  # 20251210, 1.2.3 ç­‰ï¼ˆè‡³å°‘ä¸¤ä½æ•°å­—å¼€å¤´ï¼‰
  
  workflow_dispatch:
    inputs:
      release:
        description: 'Create release (push images, create GitHub Release)'
        required: false
        default: true
        type: boolean
      platforms:
        description: 'Platforms to build (comma separated: linux,windows,macos)'
        required: false
        default: 'linux,windows,macos'
        type: string
      build_docker:
        description: 'Build Docker image'
        required: false
        default: true
        type: boolean
      docker_registries:
        description: 'Docker registries to push to (comma separated: ghcr.io,docker.io)'
        required: false
        default: 'ghcr.io,docker.io'
        type: string
      use_china_mirror:
        description: 'Use China mirror for faster downloads'
        required: false
        default: false
        type: boolean

env:
  BINARY_NAME: ${{ github.event.repository.name }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  setup-platforms:
    name: Setup Platform Flags
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.set-platforms.outputs.build_linux }}
      build_windows: ${{ steps.set-platforms.outputs.build_windows }}
      build_macos: ${{ steps.set-platforms.outputs.build_macos }}
      version: ${{ steps.get-version.outputs.version }}
      has_binaries: ${{ steps.set-platforms.outputs.has_binaries }}
      push_ghcr: ${{ steps.parse-registries.outputs.push_ghcr }}
      push_dockerhub: ${{ steps.parse-registries.outputs.push_dockerhub }}
      any_registry: ${{ steps.parse-registries.outputs.any_registry }}
      has_dockerhub_creds: ${{ steps.check-dockerhub-creds.outputs.has_dockerhub_creds }}
      repository_lower: ${{ steps.get-repo-lower.outputs.repository_lower }}
      binary_name_lower: ${{ steps.get-repo-lower.outputs.binary_name_lower }}
      is_tag_push: ${{ steps.check-trigger.outputs.is_tag_push }}
      should_release: ${{ steps.check-trigger.outputs.should_release }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check trigger type
        id: check-trigger
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            echo "is_tag_push=true" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ Tag push detected: ${{ github.ref_name }}"
          else
            echo "is_tag_push=false" >> $GITHUB_OUTPUT
            echo "should_release=${{ inputs.release }}" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Manual workflow dispatch"
          fi
      
      - name: Get repository name in lowercase
        id: get-repo-lower
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          BINARY_LOWER=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "binary_name_lower=$BINARY_LOWER" >> $GITHUB_OUTPUT
          echo "ğŸ“ Repository (lowercase): $REPO_LOWER"
          echo "ğŸ“„ Binary name (lowercase): $BINARY_LOWER"
      
      - name: Set platforms based on trigger type
        id: set-platforms
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            # Tag æ¨é€ï¼šé»˜è®¤æ„å»ºæ‰€æœ‰å¹³å°
            echo "build_linux=true" >> $GITHUB_OUTPUT
            echo "build_windows=true" >> $GITHUB_OUTPUT
            echo "build_macos=true" >> $GITHUB_OUTPUT
            echo "has_binaries=true" >> $GITHUB_OUTPUT
            echo "âœ… Tag push: building all platforms"
          else
            # workflow_dispatchï¼šä½¿ç”¨è¾“å…¥çš„å‚æ•°
            PLATFORMS=$(echo "${{ inputs.platforms }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
            echo "Parsing platforms: $PLATFORMS"
            
            if [[ "$PLATFORMS" == *"linux"* ]]; then
              echo "build_linux=true" >> $GITHUB_OUTPUT
            else
              echo "build_linux=false" >> $GITHUB_OUTPUT
            fi
            
            if [[ "$PLATFORMS" == *"windows"* ]]; then
              echo "build_windows=true" >> $GITHUB_OUTPUT
            else
              echo "build_windows=false" >> $GITHUB_OUTPUT
            fi
            
            if [[ "$PLATFORMS" == *"macos"* ]]; then
              echo "build_macos=true" >> $GITHUB_OUTPUT
            else
              echo "build_macos=false" >> $GITHUB_OUTPUT
            fi
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•äºŒè¿›åˆ¶æ„å»º
            if [[ "$PLATFORMS" == *"linux"* ]] || \
               [[ "$PLATFORMS" == *"windows"* ]] || \
               [[ "$PLATFORMS" == *"macos"* ]]; then
              echo "has_binaries=true" >> $GITHUB_OUTPUT
            else
              echo "has_binaries=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Parse docker registries
        id: parse-registries
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            REGISTRIES=$(echo "${{ inputs.docker_registries }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          else
            # Tag æ¨é€æ—¶ä½¿ç”¨é»˜è®¤å€¼
            REGISTRIES="ghcr.io,docker.io"
          fi
          
          echo "Parsing registries: $REGISTRIES"
          
          if [[ "$REGISTRIES" == *"ghcr.io"* ]] || [[ "$REGISTRIES" == *"ghcr"* ]]; then
            echo "push_ghcr=true" >> $GITHUB_OUTPUT
          else
            echo "push_ghcr=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$REGISTRIES" == *"docker.io"* ]] || [[ "$REGISTRIES" == *"dockerhub"* ]] || [[ "$REGISTRIES" == *"hub.docker.com"* ]]; then
            echo "push_dockerhub=true" >> $GITHUB_OUTPUT
          else
            echo "push_dockerhub=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$REGISTRIES" == *"ghcr"* ]] || [[ "$REGISTRIES" == *"docker"* ]] || [[ -n "$REGISTRIES" ]]; then
            echo "any_registry=true" >> $GITHUB_OUTPUT
          else
            echo "any_registry=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Docker Hub credentials
        id: check-dockerhub-creds
        run: |
          if [[ -n "$DOCKERHUB_USERNAME" ]] && [[ -n "$DOCKERHUB_TOKEN" ]]; then
            echo "has_dockerhub_creds=true" >> $GITHUB_OUTPUT
            echo "âœ… Docker Hub credentials available"
          else
            echo "has_dockerhub_creds=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Docker Hub credentials not configured"
          fi
      
      - name: Get version from tag
        id: get-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="latest"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "ğŸ·ï¸ Version: $VERSION"

  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    needs: setup-platforms
    if: ${{ needs.setup-platforms.outputs.build_linux == 'true' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install musl toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: x86_64-unknown-linux-musl
      
      - name: Build static binary
        run: |
          echo "ğŸ—ï¸ Building Linux static binary (musl)..."
          cargo build --release --target x86_64-unknown-linux-musl
          
          echo "ğŸ“Š Binary info:"
          file target/x86_64-unknown-linux-musl/release/$BINARY_NAME
          ls -lh target/x86_64-unknown-linux-musl/release/$BINARY_NAME
      
      - name: Test binary
        run: |
          echo "ğŸ§ª Testing Linux binary..."
          ./target/x86_64-unknown-linux-musl/release/$BINARY_NAME --version || \
          ./target/x86_64-unknown-linux-musl/release/$BINARY_NAME --help || \
          echo "âœ… Binary execution successful"
      
      - name: Prepare artifact
        run: |
          mkdir -p release-binaries
          cp target/x86_64-unknown-linux-musl/release/$BINARY_NAME \
             release-binaries/$BINARY_NAME-linux-amd64
          chmod +x release-binaries/$BINARY_NAME-linux-amd64
          
          FILE_SIZE=$(du -h release-binaries/$BINARY_NAME-linux-amd64 | cut -f1)
          echo "ğŸ“„ Binary: $BINARY_NAME-linux-amd64 ($FILE_SIZE)"
      
      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: release-binaries/
          retention-days: 1

  build-windows:
    name: Build Windows Binary
    runs-on: windows-latest
    needs: setup-platforms
    if: ${{ needs.setup-platforms.outputs.build_windows == 'true' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: x86_64-pc-windows-msvc
      
      - name: Build
        run: |
          echo "ğŸ—ï¸ Building Windows binary..."
          cargo build --release --target x86_64-pc-windows-msvc
          
          echo "ğŸ“Š Binary info:"
          dir "target\x86_64-pc-windows-msvc\release\$env:BINARY_NAME.exe"
      
      - name: Test binary
        run: |
          $binaryPath = "target\x86_64-pc-windows-msvc\release\$env:BINARY_NAME.exe"
          & $binaryPath --version || & $binaryPath --help || echo "âœ… Binary test completed"
      
      - name: Prepare artifact
        run: |
          $binaryPath = "target\x86_64-pc-windows-msvc\release\$env:BINARY_NAME.exe"
          $artifactDir = "release-artifacts"
          
          New-Item -ItemType Directory -Force -Path $artifactDir
          $outputName = "$env:BINARY_NAME-windows-amd64.exe"
          Copy-Item $binaryPath "$artifactDir\$outputName"
          
          $fileInfo = Get-Item "$artifactDir\$outputName"
          $fileSize = [math]::Round($fileInfo.Length / 1MB, 2)
          echo "ğŸ“„ Binary: $outputName (${fileSize} MB)"
      
      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: release-artifacts/
          retention-days: 1

  build-macos:
    name: Build macOS Binaries
    runs-on: macos-latest
    needs: setup-platforms
    if: ${{ needs.setup-platforms.outputs.build_macos == 'true' }}
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Build
        run: |
          echo "ğŸ—ï¸ Building for target: ${{ matrix.target }}"
          cargo build --release --target ${{ matrix.target }}
          
          echo "ğŸ“Š Binary info:"
          file target/${{ matrix.target }}/release/$BINARY_NAME
      
      - name: Test binary
        run: |
          binary_path="target/${{ matrix.target }}/release/$BINARY_NAME"
          ./$binary_path --version || ./$binary_path --help || echo "âœ… Binary test completed"
      
      - name: Prepare artifact
        run: |
          binary_path="target/${{ matrix.target }}/release/$BINARY_NAME"
          artifact_dir="release-artifacts"
          
          mkdir -p $artifact_dir
          
          if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
            output_name="$BINARY_NAME-macos-arm64"
          else
            output_name="$BINARY_NAME-macos-amd64"
          fi
          
          cp $binary_path "$artifact_dir/$output_name"
          chmod +x "$artifact_dir/$output_name"
          
          file_size=$(du -h "$artifact_dir/$output_name" | cut -f1)
          echo "ğŸ“„ Binary: $output_name (${file_size})"
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: release-artifacts/
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: 
      - setup-platforms
      - build-linux
      - build-windows
      - build-macos
    permissions:
      contents: write
    if: >
      needs.setup-platforms.outputs.should_release == 'true' &&
      needs.setup-platforms.outputs.has_binaries == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Linux binary
        if: ${{ needs.setup-platforms.outputs.build_linux == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: linux-binary
          path: release-assets
      
      - name: Download Windows binary
        if: ${{ needs.setup-platforms.outputs.build_windows == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: release-assets
      
      - name: Download macOS binaries
        if: ${{ needs.setup-platforms.outputs.build_macos == 'true' }}
        uses: actions/download-artifact@v4
        with:
          pattern: macos-*
          path: release-assets
      
      - name: Prepare release files
        run: |
          mkdir -p final-release
          
          echo "ğŸ“¦ Collecting release files..."
          
          # Linux äºŒè¿›åˆ¶
          if [ -d "release-assets/linux-binary" ]; then
            find release-assets/linux-binary -type f ! -name "*.json" | while read file; do
              filename=$(basename "$file")
              cp "$file" "final-release/$filename"
              echo "âœ… Added: $filename"
            done
          fi
          
          # Windows äºŒè¿›åˆ¶
          if [ -d "release-assets/windows-binary" ]; then
            find release-assets/windows-binary -type f ! -name "*.json" | while read file; do
              filename=$(basename "$file")
              cp "$file" "final-release/$filename"
              echo "âœ… Added: $filename"
            done
          fi
          
          # macOS äºŒè¿›åˆ¶
          if [ -d "release-assets" ]; then
            find release-assets -type f -name "macos-*" ! -name "*.json" | while read file; do
              filename=$(basename "$file")
              cp "$file" "final-release/$filename"
              echo "âœ… Added: $filename"
            done
          fi
          
          echo "ğŸ“„ Release files:"
          ls -lh final-release/
      
      - name: Create checksums
        run: |
          cd final-release
          echo "ğŸ” Creating checksums..."
          for file in *; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256"
              sha512sum "$file" > "$file.sha512"
              echo "âœ… Checksums for: $file"
            fi
          done
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: final-release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(needs.setup-platforms.outputs.version, '-alpha') || contains(needs.setup-platforms.outputs.version, '-beta') || contains(needs.setup-platforms.outputs.version, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: setup-platforms
    if: >
      ((github.event_name == 'push' && github.ref_type == 'tag' && 
        needs.setup-platforms.outputs.any_registry == 'true') ||
       (github.event_name == 'workflow_dispatch' && inputs.build_docker && 
        needs.setup-platforms.outputs.any_registry == 'true'))
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GHCR
        if: ${{ needs.setup-platforms.outputs.push_ghcr == 'true' && needs.setup-platforms.outputs.should_release == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Log in to Docker Hub
        if: ${{ needs.setup-platforms.outputs.push_dockerhub == 'true' && 
                needs.setup-platforms.outputs.has_dockerhub_creds == 'true' && 
                needs.setup-platforms.outputs.should_release == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}
      
      - name: Prepare Docker tags
        id: prepare-tags
        run: |
          TAGS=""
          
          # GHCR tags
          if [ "${{ needs.setup-platforms.outputs.push_ghcr }}" = "true" ]; then
            if [ "${{ needs.setup-platforms.outputs.should_release }}" = "true" ]; then
              # å‘å¸ƒæ¨¡å¼ï¼šæ¨é€åˆ°registry
              TAGS="$TAGS,ghcr.io/${{ needs.setup-platforms.outputs.repository_lower }}:${{ needs.setup-platforms.outputs.version }}"
              if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ needs.setup-platforms.outputs.version }}" = "latest" ]; then
                TAGS="$TAGS,ghcr.io/${{ needs.setup-platforms.outputs.repository_lower }}:latest"
              fi
            else
              # éå‘å¸ƒæ¨¡å¼ï¼šæœ¬åœ°æ„å»º
              TAGS="$TAGS,ghcr.io/${{ needs.setup-platforms.outputs.repository_lower }}:standalone-${{ github.sha }}"
            fi
          fi
          
          # Docker Hub tags
          if [ "${{ needs.setup-platforms.outputs.push_dockerhub }}" = "true" ] && [ "${{ needs.setup-platforms.outputs.has_dockerhub_creds }}" = "true" ]; then
            if [ "${{ needs.setup-platforms.outputs.should_release }}" = "true" ]; then
              TAGS="$TAGS,$DOCKERHUB_USERNAME/${{ needs.setup-platforms.outputs.binary_name_lower }}:${{ needs.setup-platforms.outputs.version }}"
              if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ needs.setup-platforms.outputs.version }}" = "latest" ]; then
                TAGS="$TAGS,$DOCKERHUB_USERNAME/${{ needs.setup-platforms.outputs.binary_name_lower }}:latest"
              fi
            else
              TAGS="$TAGS,$DOCKERHUB_USERNAME/${{ needs.setup-platforms.outputs.binary_name_lower }}:standalone-${{ github.sha }}"
            fi
          fi
          
          # ç§»é™¤å¼€å¤´çš„é€—å·
          TAGS="${TAGS#,}"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Docker tags: $TAGS"
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: ${{ needs.setup-platforms.outputs.should_release == 'true' }}
          tags: ${{ steps.prepare-tags.outputs.tags }}
          build-args: |
            USE_CHINA_MIRROR=${{ github.event_name == 'workflow_dispatch' && inputs.use_china_mirror || 'false' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: ${{ needs.setup-platforms.outputs.should_release != 'true' && 'type=docker,dest=/tmp/image.tar' || '' }}
      
      - name: Test Docker image locally (non-release)
        if: ${{ needs.setup-platforms.outputs.should_release != 'true' }}
        run: |
          echo "ğŸ”§ Testing standalone Docker image..."
          docker load -i /tmp/image.tar
          IMAGE_ID=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -1)
          docker run --rm "$IMAGE_ID" --version || \
          docker run --rm "$IMAGE_ID" --help || \
          echo "âœ… Standalone image test complete"
      
      - name: Save local artifacts (non-release)
        if: ${{ needs.setup-platforms.outputs.should_release != 'true' }}
        run: |
          mkdir -p /tmp/local-artifacts
          cp /tmp/image.tar /tmp/local-artifacts/docker-image-local.tar
          echo "âœ… Local artifacts saved"
      
      - name: Upload local artifacts (non-release)
        if: ${{ needs.setup-platforms.outputs.should_release != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-local
          path: /tmp/local-artifacts/
          retention-days: 1

  build-report:
    name: Build and Release Report
    runs-on: ubuntu-latest
    needs: 
      - setup-platforms
      - build-linux
      - build-windows
      - build-macos
      - create-release
      - build-docker
    if: always()
    
    steps:
      - name: Generate final report
        run: |
          echo "ğŸ‰ Build Pipeline Completed"
          echo "========================="
          echo ""
          
          # è§¦å‘ç±»å‹
          if [ "${{ needs.setup-platforms.outputs.is_tag_push }}" = "true" ]; then
            echo "ğŸš€ TRIGGER: Tag Push (${{ github.ref_name }})"
            echo "âš™ï¸ Configuration Summary:"
            echo "  Release mode: ğŸš€ AUTOMATIC TAG RELEASE"
            echo "  Platforms: All (linux,windows,macos)"
            echo "  Docker build: ${{ needs.setup-platforms.outputs.any_registry == 'true' && 'âœ… Yes' || 'â¸ï¸ No' }}"
            echo "  Docker registries: ${{ needs.setup-platforms.outputs.push_ghcr == 'true' && 'ghcr.io' || '' }} ${{ needs.setup-platforms.outputs.push_dockerhub == 'true' && 'docker.io' || '' }}"
          else
            echo "ğŸ”§ TRIGGER: Manual Workflow Dispatch"
            echo "âš™ï¸ Configuration Summary:"
            echo "  Release mode: ${{ inputs.release && 'ğŸš€ RELEASE' || 'ğŸ”§ LOCAL BUILD' }}"
            echo "  Platforms: ${{ inputs.platforms || 'None (Docker only)' }}"
            echo "  Docker build: ${{ inputs.build_docker && 'âœ… Yes' || 'â¸ï¸ No' }}"
            echo "  Docker registries: ${{ inputs.docker_registries || 'None' }}"
            echo "  China mirror: ${{ inputs.use_china_mirror && 'âœ… Enabled' || 'â¸ï¸ Disabled' }}"
          fi
          
          echo ""
          echo "ğŸ“Š Build Results:"
          echo ""
          
          # äºŒè¿›åˆ¶æ„å»ºçŠ¶æ€
          if [ "${{ needs.setup-platforms.outputs.has_binaries }}" = "true" ]; then
            echo "ğŸ“¦ Binary Artifacts:"
            echo "  ğŸ§ Linux: ${{ needs.setup-platforms.outputs.build_linux && 'âœ… Built' || 'â¸ï¸ Skipped' }}"
            echo "  ğŸªŸ Windows: ${{ needs.setup-platforms.outputs.build_windows && 'âœ… Built' || 'â¸ï¸ Skipped' }}"
            echo "  ğŸ macOS: ${{ needs.setup-platforms.outputs.build_macos && 'âœ… Built' || 'â¸ï¸ Skipped' }}"
            echo ""
            
            if [ "${{ needs.setup-platforms.outputs.should_release }}" = "true" ]; then
              echo "ğŸš€ GitHub Release: âœ… Created"
              echo "  Version: ${{ needs.setup-platforms.outputs.version }}"
              echo "  Files: Binaries + SHA256/SHA512 checksums"
            else
              echo "ğŸ“¥ Artifacts: âœ… Saved as GitHub Actions artifacts"
            fi
          else
            echo "ğŸ“¦ Binaries: â¸ï¸ Not built (Docker only mode)"
            echo ""
          fi
          
          # Docker çŠ¶æ€
          if [ "${{ needs.setup-platforms.outputs.any_registry }}" = "true" ] && [ "${{ needs.setup-platforms.outputs.is_tag_push }}" = "true" || "${{ inputs.build_docker }}" = "true" ]; then
            echo "ğŸ³ Docker Image:"
            
            if [ "${{ needs.setup-platforms.outputs.should_release }}" = "true" ]; then
              echo "  Mode: ğŸš€ Pushed to registry"
              if [ "${{ needs.setup-platforms.outputs.push_ghcr }}" = "true" ]; then
                echo "  âœ… GHCR: ghcr.io/${{ needs.setup-platforms.outputs.repository_lower }}:${{ needs.setup-platforms.outputs.version }}"
              fi
              if [ "${{ needs.setup-platforms.outputs.push_dockerhub }}" = "true" ] && [ "${{ needs.setup-platforms.outputs.has_dockerhub_creds }}" = "true" ]; then
                echo "  âœ… Docker Hub: ${{ env.DOCKERHUB_USERNAME }}/${{ needs.setup-platforms.outputs.binary_name_lower }}:${{ needs.setup-platforms.outputs.version }}"
              elif [ "${{ needs.setup-platforms.outputs.push_dockerhub }}" = "true" ]; then
                echo "  âš ï¸ Docker Hub: Skipped (credentials not configured)"
              fi
            else
              echo "  Mode: ğŸ”§ Local build (testing)"
              echo "  âœ… Image saved locally for testing"
              if [ "${{ needs.setup-platforms.outputs.push_ghcr }}" = "true" ]; then
                echo "  Tag: standalone-${{ github.sha }}"
              fi
            fi
          else
            echo "ğŸ³ Docker Image: â¸ï¸ Not built"
          fi
          
          echo ""
          echo "ğŸ”— Access Links:"
          if [ "${{ needs.setup-platforms.outputs.should_release }}" = "true" ] && [ "${{ needs.setup-platforms.outputs.has_binaries }}" = "true" ]; then
            echo "  ğŸ“¦ GitHub Release: https://github.com/${{ github.repository }}/releases"
          fi
          if [ "${{ needs.setup-platforms.outputs.should_release }}" = "true" ] && [ "${{ needs.setup-platforms.outputs.any_registry }}" = "true" ]; then
            if [ "${{ needs.setup-platforms.outputs.push_ghcr }}" = "true" ]; then
              echo "  ğŸ³ GHCR: https://ghcr.io/${{ needs.setup-platforms.outputs.repository_lower }}"
            fi
            if [ "${{ needs.setup-platforms.outputs.push_dockerhub }}" = "true" ] && [ "${{ needs.setup-platforms.outputs.has_dockerhub_creds }}" = "true" ]; then
              echo "  ğŸ³ Docker Hub: https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/${{ needs.setup-platforms.outputs.binary_name_lower }}"
            fi
          fi
          
          echo ""
          echo "â±ï¸ Next Steps:"
          if [ "${{ needs.setup-platforms.outputs.should_release }}" = "true" ]; then
            echo "  1. Verify the released binaries on GitHub"
            echo "  2. Test the Docker image from registry"
            echo "  3. Update documentation with new version"
          else
            echo "  1. Download artifacts for local testing"
            echo "  2. Run integration tests"
            echo "  3. When ready, re-run with release:true"
          fi