name: Build macOS Binaries and Release

on:
  # push:
  #   tags:
  #     - 'v*'  # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      debug_mode:
        description: 'Enable debug mode (save artifacts without release)'
        required: false
        default: false
        type: boolean
      enable_release:
        description: 'Enable GitHub Release creation'
        required: false
        default: true
        type: boolean
      build_universal:
        description: 'Build universal binary for both Intel and Apple Silicon'
        required: false
        default: true
        type: boolean

env:
  BINARY_NAME: ${{ github.event.repository.name }}

jobs:
  build-macos-binaries:
    name: Build macOS Binaries
    runs-on: macos-latest
    strategy:
      matrix:
        target: 
          - x86_64-apple-darwin      # Intel Mac
          - aarch64-apple-darwin     # Apple Silicon (M1/M2/M3)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up flags
        id: flags
        run: |
          # è®¾ç½® debug_mode æ ‡å¿—
          if [ "${{ inputs.debug_mode }}" = "true" ]; then
            echo "debug_mode=true" >> $GITHUB_OUTPUT
          else
            echo "debug_mode=false" >> $GITHUB_OUTPUT
          fi

          if [ "${{ inputs.enable_release }}" = "true" ]; then
            echo "enable_release=true" >> $GITHUB_OUTPUT
          else
            echo "enable_release=false" >> $GITHUB_OUTPUT
          fi

          if [ "${{ inputs.build_universal }}" = "true" ]; then
            echo "build_universal=true" >> $GITHUB_OUTPUT
          else
            echo "build_universal=false" >> $GITHUB_OUTPUT
          fi

          # æ£€æµ‹æ˜¯å¦æ˜¯ main åˆ†æ”¯
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi
          
          echo "debug_mode: ${{ steps.flags.outputs.debug_mode }}"
          echo "build_universal: ${{ steps.flags.outputs.build_universal }}"
          echo "is_main: ${{ steps.flags.outputs.is_main }}"

      - name: Debug Information
        run: |
          echo "ğŸ”§ Debug Mode: ${{ inputs.debug_mode }}"
          echo "ğŸ Build Universal: ${{ inputs.build_universal }}"
          echo "ğŸ·ï¸ Trigger Event: ${{ github.event_name }}"
          echo "ğŸ”– Ref: ${{ github.ref }}"
          echo "ğŸ“ SHA: ${{ github.sha }}"
          echo "ğŸ’» Runner OS: $(uname -a)"
          echo "ğŸ macOS Version: $(sw_vers -productVersion)"
          echo "ğŸ–¥ï¸  Architecture: $(uname -m)"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ matrix.target }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}

      - name: Build debug information
        run: |
          echo "ğŸ”§ Build Configuration:"
          echo "Target: ${{ matrix.target }}"
          echo "Rust Version: $(rustc --version)"
          echo "Cargo Version: $(cargo --version)"
          echo "macOS SDK Path: $(xcrun --show-sdk-path)"

      - name: Build release binary
        run: |
          echo "ğŸ Building for target: ${{ matrix.target }}"
          
          # è®¾ç½® macOS éƒ¨ç½²ç›®æ ‡ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
          export MACOSX_DEPLOYMENT_TARGET="10.13"
          
          # æ„å»º release ç‰ˆæœ¬
          cargo build --release --target ${{ matrix.target }}
          
          echo "ğŸ“ Build output:"
          find "target/${{ matrix.target }}/release/" -name "$BINARY_NAME" -type f 2>/dev/null | while read file; do
            size=$(stat -f%z "$file")
            size_mb=$(echo "scale=2; $size / 1048576" | bc)
            echo "  - $(basename "$file") (${size_mb} MB)"
          done

      - name: Test binary
        run: |
          binary_path="target/${{ matrix.target }}/release/$BINARY_NAME"
          
          if [ -f "$binary_path" ]; then
            echo "ğŸ§ª Testing binary: $binary_path"
            
            # æ£€æŸ¥æ–‡ä»¶æƒé™
            chmod +x "$binary_path"
            
            # æ£€æŸ¥äºŒè¿›åˆ¶æ¶æ„
            echo "ğŸ“Š Binary architecture:"
            file "$binary_path"
            
            # æ£€æŸ¥æ”¯æŒçš„æ¶æ„
            echo "ğŸ—ï¸  Supported architectures:"
            lipo -archs "$binary_path" 2>/dev/null || echo "Single architecture binary"
            
            # å°è¯•è¿è¡Œç‰ˆæœ¬æ£€æŸ¥æˆ–å¸®åŠ©å‘½ä»¤
            if "$binary_path" --version 2>/dev/null; then
              echo "âœ… Version check passed"
            elif "$binary_path" --help 2>/dev/null; then
              echo "âœ… Help command executed successfully"
            else
              echo "âœ… Binary executed successfully (no --version or --help flag)"
            fi
          else
            echo "âŒ Binary not found at: $binary_path"
            echo "Available files in target directory:"
            find "target/${{ matrix.target }}/release/" -type f | head -20
          fi

      - name: Prepare artifacts
        if: ${{ !inputs.enable_release }}
        id: prepare-artifacts
        run: |
          binary_path="target/${{ matrix.target }}/release/$BINARY_NAME"
          artifact_dir="release-artifacts"
          target_name="${{ matrix.target }}"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p "$artifact_dir"
          
          if [ -f "$binary_path" ]; then
            # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
            output_name="$BINARY_NAME-${target_name//-/_}"
            cp "$binary_path" "$artifact_dir/$output_name"
            
            # è·å–æ–‡ä»¶ä¿¡æ¯
            file_size=$(stat -f%z "$binary_path")
            file_size_mb=$(echo "scale=2; $file_size / 1048576" | bc)
            
            # ä¸ºæ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™
            chmod +x "$artifact_dir/$output_name"
            
            # è¾“å‡ºå˜é‡ï¼ˆä½¿ç”¨ä¸‹åˆ’çº¿æ›¿æ¢ç ´æŠ˜å·ï¼‰
            var_suffix="${target_name//-/_}"
            echo "binary_path_${var_suffix}=$artifact_dir/$output_name" >> $GITHUB_OUTPUT
            echo "binary_size_${var_suffix}=${file_size_mb}MB" >> $GITHUB_OUTPUT
            
            echo "âœ… Prepared artifact: $output_name (${file_size_mb} MB)"
            
            # æ˜¾ç¤ºäºŒè¿›åˆ¶ä¿¡æ¯
            echo "ğŸ“Š Artifact information:"
            file "$artifact_dir/$output_name"
          else
            echo "âŒ Binary not found: $binary_path"
            # å°è¯•æ‰¾åˆ°ä»»ä½•å¯æ‰§è¡Œæ–‡ä»¶
            echo "Searching for alternative executables..."
            find "target/${{ matrix.target }}/release/" -type f -executable 2>/dev/null | head -5 | while read exe_file; do
              exe_name=$(basename "$exe_file")
              output_name="${exe_name}-${target_name//-/_}"
              cp "$exe_file" "$artifact_dir/$output_name"
              echo "  - Found: $exe_name -> $output_name"
            done
          fi
          
          # è¾“å‡ºé€šç”¨ä¿¡æ¯
          echo "artifact_dir=$artifact_dir" >> $GITHUB_OUTPUT
          echo "target_name=$target_name" >> $GITHUB_OUTPUT

      - name: Create universal binary (optional)
        if: ${{ inputs.build_universal && matrix.target == 'x86_64-apple-darwin' }}
        run: |
          echo "ğŸ”„ Creating universal binary..."
          
          intel_binary="target/x86_64-apple-darwin/release/$BINARY_NAME"
          arm_binary="target/aarch64-apple-darwin/release/$BINARY_NAME"
          universal_binary="target/$BINARY_NAME-universal"
          
          if [ -f "$intel_binary" ] && [ -f "$arm_binary" ]; then
            # ä½¿ç”¨ lipo åˆ›å»ºé€šç”¨äºŒè¿›åˆ¶
            lipo -create "$intel_binary" "$arm_binary" -output "$universal_binary"
            
            echo "âœ… Universal binary created:"
            file "$universal_binary"
            lipo -archs "$universal_binary"
            
            # å¤åˆ¶åˆ° artifacts ç›®å½•
            mkdir -p "release-artifacts"
            cp "$universal_binary" "release-artifacts/$BINARY_NAME-universal-apple-darwin"
            chmod +x "release-artifacts/$BINARY_NAME-universal-apple-darwin"
            
            # è®¡ç®—æ–‡ä»¶å¤§å°
            universal_size=$(stat -f%z "$universal_binary")
            universal_size_mb=$(echo "scale=2; $universal_size / 1048576" | bc)
            echo "binary_path_universal=release-artifacts/$BINARY_NAME-universal-apple-darwin" >> $GITHUB_OUTPUT
            echo "binary_size_universal=${universal_size_mb}MB" >> $GITHUB_OUTPUT
            
            echo "ğŸ¯ Universal binary size: ${universal_size_mb} MB"
          else
            echo "âš ï¸  Cannot create universal binary: missing architecture binaries"
            [ -f "$intel_binary" ] || echo "  âŒ Missing Intel binary"
            [ -f "$arm_binary" ] || echo "  âŒ Missing ARM binary"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries-${{ matrix.target }}
          path: release-artifacts/
          retention-days: 1

      - name: Build completion report
        run: |
          echo "ğŸ‰ macOS Build Completed Successfully"
          echo "===================================="
          echo "ğŸ·ï¸ Target: ${{ matrix.target }}"
          echo "ğŸ“¦ Binary: $BINARY_NAME"
          echo "ğŸ“ Artifact: macos-binaries-${{ matrix.target }}"
          echo "ğŸ”§ Rust Toolchain: stable"
          echo "ğŸ macOS Version: $(sw_vers -productVersion)"
          if [ "${{ inputs.build_universal }}" = "true" ] && [ "${{ matrix.target }}" = "x86_64-apple-darwin" ]; then
            echo "ğŸ”„ Universal binary: Created"
          fi

  create-release:
    name: Create GitHub Release
    runs-on: macos-latest
    needs: build-macos-binaries
    permissions:
      contents: write
    if: >
      github.event.inputs.enable_release == 'true' &&
      github.event.inputs.debug_mode != 'true' &&
      (startsWith(github.ref, 'refs/tags/') || github.event.inputs.release_tag != '')
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p "release-binaries"
          echo "ğŸ“¥ Downloading artifacts for release..."

      - name: Download Intel artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries-x86_64-apple-darwin
          path: release-binaries/intel

      - name: Download ARM artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries-aarch64-apple-darwin
          path: release-binaries/arm

      - name: Prepare release files
        run: |
          echo "ğŸ“¦ Preparing release files..."
          release_dir="final-release"
          mkdir -p "$release_dir"
          
          # å¤åˆ¶ Intel äºŒè¿›åˆ¶æ–‡ä»¶
          echo "ğŸ”§ Intel binaries:"
          find "release-binaries/intel" -type f -executable 2>/dev/null | while read file; do
            filename=$(basename "$file")
            # é‡å‘½åä»¥æ˜ç¡®æ¶æ„
            if [[ "$filename" == *"universal"* ]]; then
              new_name="${filename}"
            elif [[ "$filename" == *"x86_64"* ]]; then
              new_name="${filename//x86_64_apple_darwin/intel}"
            else
              new_name="${filename}-intel"
            fi
            cp "$file" "$release_dir/$new_name"
            echo "âœ… Added: $new_name"
          done
          
          # å¤åˆ¶ ARM äºŒè¿›åˆ¶æ–‡ä»¶
          echo "ğŸ ARM binaries:"
          find "release-binaries/arm" -type f -executable 2>/dev/null | while read file; do
            filename=$(basename "$file")
            if [[ "$filename" == *"aarch64"* ]]; then
              new_name="${filename//aarch64_apple_darwin/arm64}"
            else
              new_name="${filename}-arm64"
            fi
            cp "$file" "$release_dir/$new_name"
            echo "âœ… Added: $new_name"
          done
          
          # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
          echo "ğŸ“„ Release files:"
          find "$release_dir" -type f | while read file; do
            filename=$(basename "$file")
            size=$(stat -f%z "$file")
            size_mb=$(echo "scale=2; $size / 1048576" | bc)
            echo "  - $filename (${size_mb} MB)"
            
            # æ˜¾ç¤ºæ¶æ„ä¿¡æ¯
            if file "$file" | grep -q "Mach-O"; then
              echo "    Architecture:"
              if lipo -archs "$file" 2>/dev/null; then
                echo ""
              else
                file "$file" | grep -o "Mach-O.*"
              fi
            fi
          done

      - name: Create checksums
        run: |
          echo "ğŸ” Creating checksums..."
          cd final-release
          
          # ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºæ ¡éªŒå’Œ
          find . -type f -executable 2>/dev/null | while read file; do
            filename=$(basename "$file")
            
            # SHA256
            sha256=$(shasum -a 256 "$filename" | cut -d' ' -f1)
            echo "$sha256 *$filename" > "$filename.sha256"
            
            # SHA512
            sha512=$(shasum -a 512 "$filename" | cut -d' ' -f1)
            echo "$sha512 *$filename" > "$filename.sha512"
            
            # BLAKE3 (å¯é€‰ï¼Œç°ä»£æ ¡éªŒå’Œ)
            if command -v b3sum &> /dev/null; then
              brew install b3sum 2>/dev/null || true
            fi
            if command -v b3sum &> /dev/null; then
              b3sum "$filename" > "$filename.b3sum"
              echo "âœ… Created BLAKE3 checksum for: $filename"
            fi
            
            echo "âœ… Created checksums for: $filename"
            echo "  SHA256: $sha256"
            echo "  SHA512: $sha512"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: final-release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release completion report
        run: |
          echo "ğŸš€ macOS Release Published Successfully"
          echo "======================================"
          echo "ğŸ·ï¸ Tag: ${GITHUB_REF#refs/tags/}"
          echo "ğŸ“¦ Binaries released:"
          find "final-release" -type f -name "*.sha256" -o -name "*.sha512" -o -name "*.b3sum" | sed 's/\..*$//' | sort -u | while read basefile; do
            filename=$(basename "$basefile")
            if [ -f "final-release/$filename" ]; then
              size=$(stat -f%z "final-release/$filename")
              size_mb=$(echo "scale=2; $size / 1048576" | bc)
              echo "  - $filename (${size_mb} MB)"
              
              # æ˜¾ç¤ºæ¶æ„
              if file "final-release/$filename" | grep -q "Mach-O"; then
                if lipo -archs "final-release/$filename" 2>/dev/null | grep -q " "; then
                  echo "    ğŸ“Š Universal binary (multiple architectures)"
                else
                  file "final-release/$filename" | grep -o "Mach-O.*"
                fi
              fi
            fi
          done
          echo "ğŸ” Checksums: SHA256 and SHA512 for each binary"
          echo "ğŸ¯ Targets: x86_64 (Intel), aarch64 (Apple Silicon)"

  debug-mode-report:
    name: Debug Mode Report
    runs-on: macos-latest
    needs: build-macos-binaries
    if: ${{ inputs.debug_mode }}
    
    steps:
      - name: Debug mode completion message
        run: |
          echo "ğŸ”§ Debug Mode Completed Successfully!"
          echo "===================================="
          echo "ğŸ Built macOS binaries for:"
          echo "  - x86_64-apple-darwin (Intel)"
          echo "  - aarch64-apple-darwin (Apple Silicon)"
          if [ "${{ inputs.build_universal }}" = "true" ]; then
            echo "  - Universal binary (Intel + Apple Silicon)"
          fi
          echo "ğŸ’¾ Artifacts saved for inspection"
          echo "ğŸš« No release created (debug mode)"
          echo "ğŸ”„ To publish release, re-run with enable_release=true"
          echo ""
          echo "ğŸ“Š System Information:"
          echo "  macOS Version: $(sw_vers -productVersion)"
          echo "  Build Version: $(sw_vers -buildVersion)"
          echo "  Hardware: $(system_profiler SPHardwareDataType | grep 'Model Name' | head -1 | cut -d: -f2 | xargs)"