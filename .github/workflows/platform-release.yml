name: Multi-Platform Build and Release

on:
  push:
    tags:
      - 'v*'  # æŽ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      debug_mode:
        description: 'Dry run mode (build but skip release)'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Simulate build without actual compilation'
        required: false
        default: false
        type: boolean
      platforms:
        description: 'Platforms: windows,linux,macos or all'
        required: false
        default: 'windows,linux,macos'
        type: string
      architectures:
        description: 'Architectures: x86_64,aarch64,armv7 or all'
        required: false
        default: 'x86_64'
        type: string

env:
  BINARY_NAME: ${{ github.event.repository.name }}

jobs:
  # ç®€åŒ–çš„çŸ©é˜µæž„å»º
  build:
    name: Build for ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # é»˜è®¤é…ç½® - æ ¹æ®è¾“å…¥åŠ¨æ€è¿‡æ»¤
          - id: windows-x64
            platform: windows
            arch: x86_64
            runner: windows-latest
            targets: ['x86_64-pc-windows-msvc', 'x86_64-pc-windows-gnu']
            ext: '.exe'
            build_if: ${{ 
              (contains(github.event.inputs.platforms, 'windows') || 
               github.event.inputs.platforms == 'all' ||
               github.event.inputs.platforms == null) &&
              (contains(github.event.inputs.architectures, 'x86_64') ||
               github.event.inputs.architectures == 'all' ||
               github.event.inputs.architectures == null)
            }}
          
          - id: linux-x64
            platform: linux
            arch: x86_64
            runner: ubuntu-latest
            targets: ['x86_64-unknown-linux-gnu', 'x86_64-unknown-linux-musl']
            ext: ''
            build_if: ${{ 
              (contains(github.event.inputs.platforms, 'linux') ||
               github.event.inputs.platforms == 'all' ||
               github.event.inputs.platforms == null) &&
              (contains(github.event.inputs.architectures, 'x86_64') ||
               github.event.inputs.architectures == 'all' ||
               github.event.inputs.architectures == null)
            }}
          
          - id: linux-arm64
            platform: linux
            arch: aarch64
            runner: ubuntu-latest
            targets: ['aarch64-unknown-linux-gnu']
            ext: ''
            build_if: ${{ 
              (contains(github.event.inputs.platforms, 'linux') ||
               github.event.inputs.platforms == 'all' ||
               github.event.inputs.platforms == null) &&
              (contains(github.event.inputs.architectures, 'aarch64') ||
               github.event.inputs.architectures == 'all')
            }}
          
          - id: linux-armv7
            platform: linux
            arch: armv7
            runner: ubuntu-latest
            targets: ['armv7-unknown-linux-gnueabihf']
            ext: ''
            build_if: ${{ 
              (contains(github.event.inputs.platforms, 'linux') ||
               github.event.inputs.platforms == 'all' ||
               github.event.inputs.platforms == null) &&
              (contains(github.event.inputs.architectures, 'armv7') ||
               github.event.inputs.architectures == 'all')
            }}
          
          - id: macos-x64
            platform: macos
            arch: x86_64
            runner: macos-latest
            targets: ['x86_64-apple-darwin']
            ext: ''
            build_if: ${{ 
              (contains(github.event.inputs.platforms, 'macos') ||
               github.event.inputs.platforms == 'all' ||
               github.event.inputs.platforms == null) &&
              (contains(github.event.inputs.architectures, 'x86_64') ||
               github.event.inputs.architectures == 'all' ||
               github.event.inputs.architectures == null)
            }}
    
    # æ ¹æ®æ¡ä»¶è·³è¿‡ä½œä¸š
    if: ${{ matrix.build_if }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Info
        id: setup
        run: |
          echo "ðŸš€ Starting build for ${{ matrix.platform }}-${{ matrix.arch }}"
          echo "Dry run: ${{ github.event.inputs.dry_run }}"
          echo "Debug mode: ${{ github.event.inputs.debug_mode }}"
          echo "Targets: ${{ join(matrix.targets, ', ') }}"
          
          # æ ‡è®°æ˜¯å¦ä¸ºæ¨¡æ‹Ÿæž„å»º
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "DRY_RUN=true" >> $GITHUB_ENV
          else
            echo "DRY_RUN=false" >> $GITHUB_ENV
          fi

      - name: Setup Rust (Dry Run)
        if: env.DRY_RUN == 'true'
        run: |
          echo "ðŸ”§ [DRY RUN] Would install Rust toolchain"
          echo "Targets: ${{ join(matrix.targets, ', ') }}"

      - name: Setup Rust (Real)
        if: env.DRY_RUN != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ join(matrix.targets, ',') }}

      - name: Setup Cross Compilation (Linux ARM)
        if: |
          env.DRY_RUN != 'true' &&
          runner.os == 'Linux' &&
          (matrix.arch == 'aarch64' || matrix.arch == 'armv7')
        run: |
          echo "ðŸ”§ Setting up cross compilation for ${{ matrix.arch }}"
          sudo apt-get update
          
          if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          elif [[ "${{ matrix.arch }}" == "armv7" ]]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf
          fi

      - name: Build (Dry Run)
        if: env.DRY_RUN == 'true'
        run: |
          echo "ðŸ—ï¸ [DRY RUN] Would build for targets:"
          for target in ${{ join(matrix.targets, ' ') }}; do
            echo "  - $target"
          done
          
          # æ¨¡æ‹Ÿæž„å»ºè¾“å‡º
          mkdir -p artifacts
          echo "dry-run-build-${{ matrix.platform }}-${{ matrix.arch }}" > artifacts/dry-run.txt
          
          echo "âœ… Dry run completed successfully"

      - name: Build (Real)
        if: env.DRY_RUN != 'true'
        run: |
          echo "ðŸ—ï¸ Building for ${{ matrix.platform }}-${{ matrix.arch }}"
          
          for target in ${{ join(matrix.targets, ' ') }}; do
            echo "ðŸ”§ Building for: $target"
            
            # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
            case "$target" in
              aarch64-unknown-linux-gnu)
                export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
                ;;
              armv7-unknown-linux-gnueabihf)
                export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc
                ;;
            esac
            
            cargo build --release --target "$target"
            
            # éªŒè¯æž„å»º
            if [[ "${{ runner.os }}" == "Windows" ]]; then
              if [ -f "target/$target/release/${{ env.BINARY_NAME }}.exe" ]; then
                echo "âœ… Built: target/$target/release/${{ env.BINARY_NAME }}.exe"
              fi
            else
              if [ -f "target/$target/release/${{ env.BINARY_NAME }}" ]; then
                echo "âœ… Built: target/$target/release/${{ env.BINARY_NAME }}"
              fi
            fi
          done

      - name: Package Artifacts
        run: |
          echo "ðŸ“¦ Packaging artifacts..."
          ARTIFACT_DIR="artifacts-${{ matrix.platform }}-${{ matrix.arch }}"
          mkdir -p "$ARTIFACT_DIR"
          
          if [[ "${{ env.DRY_RUN }}" == "true" ]]; then
            # æ¨¡æ‹Ÿæ‰“åŒ…
            echo "simulated-binary" > "$ARTIFACT_DIR/${{ env.BINARY_NAME }}-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.ext }}"
            echo "âœ… [DRY RUN] Created simulated artifacts"
          else
            # å®žé™…æ‰“åŒ…
            for target in ${{ join(matrix.targets, ' ') }}; do
              if [[ "${{ runner.os }}" == "Windows" ]]; then
                SRC="target/$target/release/${{ env.BINARY_NAME }}.exe"
                if [ -f "$SRC" ]; then
                  # Windows æ–‡ä»¶åå¤„ç†
                  if [[ "$target" == *-msvc ]]; then
                    DEST="$ARTIFACT_DIR/${{ env.BINARY_NAME }}-windows-x64-msvc.exe"
                  else
                    DEST="$ARTIFACT_DIR/${{ env.BINARY_NAME }}-windows-x64-gnu.exe"
                  fi
                  cp "$SRC" "$DEST"
                  echo "ðŸ“¦ Packaged: $DEST"
                fi
              else
                SRC="target/$target/release/${{ env.BINARY_NAME }}"
                if [ -f "$SRC" ]; then
                  # Linux/macOS æ–‡ä»¶åå¤„ç†
                  if [[ "${{ matrix.platform }}" == "linux" ]]; then
                    if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
                      if [[ "$target" == *-musl ]]; then
                        DEST="$ARTIFACT_DIR/${{ env.BINARY_NAME }}-linux-x64-musl"
                      else
                        DEST="$ARTIFACT_DIR/${{ env.BINARY_NAME }}-linux-x64-gnu"
                      fi
                    elif [[ "${{ matrix.arch }}" == "aarch64" ]]; then
                      DEST="$ARTIFACT_DIR/${{ env.BINARY_NAME }}-linux-arm64"
                    else
                      DEST="$ARTIFACT_DIR/${{ env.BINARY_NAME }}-linux-armv7"
                    fi
                  else
                    # macOS
                    DEST="$ARTIFACT_DIR/${{ env.BINARY_NAME }}-macos-x64"
                  fi
                  cp "$SRC" "$DEST"
                  echo "ðŸ“¦ Packaged: $DEST"
                fi
              fi
            done
          fi
          
          echo "artifact_dir=$ARTIFACT_DIR" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}-binaries
          path: ${{ env.artifact_dir }}/
          retention-days: 7

  # å‘å¸ƒä½œä¸šï¼ˆæ”¯æŒdry_runï¼‰
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    # æ¡ä»¶ï¼šæ˜¯æ ‡ç­¾æŽ¨é€ ä¸” ä¸æ˜¯debug/dry_runæ¨¡å¼
    if: |
      startsWith(github.ref, 'refs/tags/') &&
      github.event.inputs.debug_mode != 'true' &&
      github.event.inputs.dry_run != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare Release
        run: |
          echo "ðŸŽ Preparing release..."
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ“ [DRY RUN] Would prepare release files"
            mkdir -p release-files
            echo "dry-run-release" > release-files/README.md
          else
            mkdir -p release-files
            
            # æ”¶é›†æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
            find all-artifacts -type f ! -name "*.txt" | while read file; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "release-files/$filename"
                echo "ðŸ“¦ Added: $filename"
              fi
            done
            
            # åˆ›å»ºæ ¡éªŒå’Œ
            cd release-files
            for file in *; do
              if [ -f "$file" ]; then
                sha256sum "$file" > "$file.sha256"
              fi
            done
            sha256sum * | grep -v '\.sha256$' > SHA256SUMS
          fi
          
          echo "ðŸ“Š Files ready for release:"
          ls -la release-files/ 2>/dev/null || echo "No files prepared"

      - name: Generate Release Notes
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ“ [DRY RUN] Would generate release notes for $TAG_NAME"
            echo "# Dry Run Release" > release-notes.md
          else
            cat > release-notes.md << EOF
          # Release $TAG_NAME
          
          ## Binaries
          
          EOF
            
            if [ -d "release-files" ]; then
              cd release-files
              for file in *; do
                if [[ "$file" != *.sha256 ]] && [[ "$file" != SHA256SUMS ]]; then
                  size=$(stat -c%s "$file" 2>/dev/null || echo "0")
                  size_mb=$(echo "scale=2; $size / 1048576" | bc 2>/dev/null || echo "0")
                  echo "- \`$file\` (${size_mb} MB)" >> ../release-notes.md
                fi
              done
            fi
            
            cat >> release-notes.md << EOF
          
          ## Verification
          
          \`\`\`bash
          sha256sum -c SHA256SUMS
          \`\`\`
          EOF
          fi

      - name: Create Release (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸš€ [DRY RUN] Would create GitHub release"
          echo "Tag: ${GITHUB_REF#refs/tags/}"
          echo "Files would be uploaded"
          echo "Release notes would be used"

      - name: Create Release (Real)
        if: github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          body_path: release-notes.md
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç®€åŒ–çš„çŠ¶æ€æ±‡æ€»
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build, create-release]
    if: always()
    
    steps:
      - name: Generate Build Report
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: \`${{ github.event.inputs.platforms || 'windows,linux,macos' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Architectures: \`${{ github.event.inputs.architectures || 'x86_64' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Dry Run: \`${{ github.event.inputs.dry_run || 'false' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Debug Mode: \`${{ github.event.inputs.debug_mode || 'false' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          
          # ç»Ÿè®¡æˆåŠŸ/å¤±è´¥/è·³è¿‡çš„æž„å»º
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          SKIPPED_COUNT=0
          
          # è¿™é‡Œç®€åŒ–æ˜¾ç¤ºï¼Œå®žé™…åº”è¯¥è§£æžæ¯ä¸ªçŸ©é˜µä½œä¸šçš„ç»“æžœ
          echo "Matrix builds completed based on configuration." >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "âœ… All builds completed successfully" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "âŒ Some builds failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Release Status" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ðŸŸ¡ Dry Run Mode - No release created" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
            echo "ðŸŸ¡ Debug Mode - No release created" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "âœ… Release created successfully!" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create-release.result }}" == "skipped" ]]; then
            echo "â­ï¸ Release skipped (not a tag or conditions not met)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Release failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Run ID: ${{ github.run_id }}*" >> $GITHUB_STEP_SUMMARY