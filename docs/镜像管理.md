## 镜像构建

### 开发时构建
```bash

```

### 生产时构建
```bash

```

### 本地构建
```bash
# 构建  alpine 版
./scripts/docker-build.sh --name=zero/i_edit_toml --target=alpine --china=true --rust-mirror=ustc --alpine-mirror=mirrors.aliyun.com

# 构建  scratch 版
./scripts/docker-build.sh --name=zero/i_edit_toml --target=prod --china=true --rust-mirror=ustc --alpine-mirror=mirrors.aliyun.com

```

## 镜像查看
```bash
# 从小到打排序 + 前10条
docker images --filter "reference=*/*" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 10

name="zero/i_edit_toml";
docker images --filter "reference=$name" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 20

```


## 镜像运行
### 传递与检查环境变量
```bash
# 检查环境变量内容
# docker run --rm --env-file .env alpine:3.20 env | grep CF_
# docker run --rm --env-file .env cloudflare-ddns:alpine | grep CF_
# docker run --rm --env-file .env cloudflare-ddns:scratch | grep CF_
```

### alpine 镜像

```bash
# enter bash shell
# docker run --rm -it $name:alpine-latest /bin/sh # this not work for using ENTRYPOINT like ["/app/app"] in dockerfile
# please use:
# docker run --rm -it --entrypoint "/bin/sh" $name:alpine-latest 

# get version
docker run --rm -it $name:alpine-latest --version

# get help
docker run --rm -it $name:alpine-latest --help

docker run --rm -it $name:alpine-latest get --help

docker run --rm -it $name:alpine-latest set --help


# 后台运行 + 非手动停止一直运行模式 + 使用环境变量文件
# docker run -d --name $name --restart unless-stopped --env-file .env $name:alpine-latest

# 后台运行 + 非手动停止一直运行模式 + 使用环境变量文件 + 健康检查
# docker run -d --name cloudflare-ddns --restart unless-stopped --env-file .env --health-cmd="/app/cloudflare-ddns --version" --health-interval=30s --health-timeout=10s --health-retries=3 cloudflare-ddns:alpine

# 服务状态检测 表格 
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 10

# 检查容器状态
# docker ps -f name=cloudflare-ddns
# docker ps -f name=$name

# 查看容器日志
# docker logs cloudflare-ddns
# docker logs $name

# 进入容器检查
# docker exec -it cloudflare-ddns /bin/sh
# docker exec -it $name /bin/sh

# 检查健康状态
# docker inspect --format='{{.State.Health.Status}}' cloudflare-ddns
# docker inspect --format='{{.State.Health.Status}}' $name


# docker stop cloudflare-ddns
# docker stop $name

# docker stop cloudflare-ddns; docker rm  cloudflare-ddns;
# docker stop $name; docker rm $name;

# docker run --rm $name --help || echo "容器正常启动"

# 测试帮助信息
# docker run --rm $name --help

# 测试版本信息  
# docker run --rm $name --version

# 测试平台信息
# docker run --rm $name --show-platform

# docker run --rm  --env-file .env $name

```

## 容器停止
```bash
# 停止所有运行中的 cloudflare-ddns 容器
# docker stop $(docker ps -a | grep cloudflare-ddns | awk '{print $1}')

docker stop $(docker ps -a | grep $name | awk '{print $1}')

# docker stop $(docker ps -a  | awk '{print $1}')
```

## 容器删除
```bash
# 删除所有 cloudflare-ddns 容器
# docker rm $(docker ps -a | grep cloudflare-ddns | awk '{print $1}')

docker rm $(docker ps -a | grep $name | awk '{print $1}')

# docker ps -a | grep -E "(cloudflare|inspiring|youthful)"
```

## 镜像删除
```bash
# 删除无名镜像
docker rmi $(docker images -f "dangling=true" -q)

# 删除所有 cloudflare-ddns 镜像
docker rmi $(docker images | grep cloudflare-ddns | awk '{print $3}')

# 除了 dev 标签外，删除所有 cloudflare-ddns 镜像
docker rmi $(docker images | grep cloudflare-ddns | grep -v dev | awk '{print $3}')

# 除了 dev 或 scratch 标签外，删除所有 cloudflare-ddns 镜像
docker rmi $(docker images | grep cloudflare-ddns | grep -v dev | grep -v scratch | grep -v optimized | awk '{print $3}')

# 除了 dev 或 scratch 标签外，删除所有 cloudflare-ddns 镜像（通过仓库和标签名）
docker rmi $(docker images | grep cloudflare-ddns | grep -v dev | grep -v scratch | grep -v optimized | awk '{print $1 ":" $2}')

```

## 镜像发布
```bash
# build docker client inside docker
docker build -f Dockerfile.docker.client -t docker-client .


# list docker client image
docker images --filter "reference=docker-client" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | (read -r header; echo "$header"; sort -hk3 ) | head -n 20

# run and use wsl docker.sock
# please set environment variable in .env file for xx scripts to run in docker
docker run -it --rm --env-file .env  -v /var/run/docker.sock:/var/run/docker.sock -w /app -v ./scripts:/app/scripts docker-client sh

# ls scripts
chmod +x ./scripts/docker-publish.sh
# ls ./scripts/docker-publish.sh

sh ./scripts/docker-publish.sh
```